= Определение связей между разделами

В отличие от рядового пользователя, администратор {dv} может расширить список доступных для вывода в представлении полей, указывая при его создании связи между разделами карточек.

На рисунке ниже представлено диалоговое окно *Настройка элементов представления*, открытое администратором {dv}. Кроме поля *Колонки представления*, имеющегося в окне, открытом рядовым пользователем, здесь расположено поле *Присоединенные разделы*, в котором можно присоединить к ведущему разделу карточки некоторый другой раздел этой же или другой карточки.

image::Setting_Views_Items.png[Окно "Настройка элементов представления", открытое администратором {dv}]

Элементы, источник данных которых хранится в ведущем разделе и не является ссылочным полем (на рисунке это элементы колонок *Название*, *Дата регистрации* и *Содержание*), определяются так же, как это описано в параграфе xref:view-data-settings.adoc[Определение информации, предназначенной для вывода в представлении].

Далее подробно опишем, каким образом настраивается элемент представления, источник данных которого расположен не в ведущем разделе и, следовательно, нуждается в присоединении.

По кнопке *Добавить*, расположенной справа от поля *Присоединенные разделы*, открывается диалог настройки дополнительных разделов, необходимых для отображения данных в представлении.

image::Attached_Section.png[Окно "Присоединенный раздел"]

В полях окна *Присоединенный раздел* прежде всего указывается *Оригинальный раздел* -- тот раздел, поле которого будет использоваться в качестве ключа для связи с другим разделом. Оригинальный раздел выбирается в окне **Выбор раздел##а, открывающемся по кнопке image:buttons/Select.png[image] справа от поля. По умолчанию в качестве оригинального всегда доступен ведущий раздел; кроме того, доступны и все разделы, присоединенные к ведущему ранее (но при создании этого же представления).

image::Select_Item_Adm.png[Окно "Выбор раздела"]

После указания оригинального раздела указывается** Оригинальное поле##, данные из которого являются ссылкой к присоединяемому разделу. После этого поля *Присоединяемый раздел* и *Присоединяемое поле* заполняются автоматически теми значениями, которые соответствуют настраиваемой связи, а поле *Псевдоним* -- предлагаемым названием присоединяемого раздела, но при необходимости значения этих полей пользователь может изменить.

Среди полей, доступных в списках *Оригинальное поле* и *Присоединяемое поле*, всегда есть системные поля:

* *InstanceID* -- идентификатор карточки;
* *ParentRowID* -- идентификатор родительской строки;
* *ParentTreeRowID* -- идентификатор родительской строки в дереве;
* *RowID* -- идентификатор строки карточки;
* *SysRowTimestamp* -- служебное поле.

[NOTE]
====
При присоединении к оригинальному разделу другого раздела этой же карточки в полях *Оригинальное поле* и *Присоединяемое поле* должен быть выбран пункт *InstanceID*.
====

Поля *Присоединяемый раздел* и *Присоединяемое поле* имеет смысл заполнять вручную в том случае, когда к ведущему разделу нужно присоединить не секцию какой-либо карточки, а таблицу базы данных {dv} и ее поле (например, таким способом можно вывести в представлении все ссылки из входящих документов). При таком присоединении необходимо обратить внимание на следующую особенность: если тип поля, по которому происходит соединение, не uniqueidentifier, то после создания представления нужно:

. xref:ViewExport.adoc[Выгрузить представление] в файл XML.
. Изменить выгруженный файл, указав в секции JoinDef у параметра DestFieldType (тип поля), его фактическое значение. Например:
+
[source,pre,codeblock]
----
<JoinDef Alias="UserJoin_1" SourceAlias="Main" SourceField="AccountName" DestField="AccountName" TableName="dvsys_users" DestFieldType="unistring"/>
----
+
Возможные типы полей: Int, Bool, DateTime, UniqueId, String, Unistring, Float, Decimal, Binary.
. xref:ViewImport.adoc[Импортировать представление] из изменённого файла.

После создания присоединенного раздела данные из него могут быть указаны в качестве элемента представления. Для этого нужно вернуться к полю *Колонки представления*, выделить нужную строчку и двойным щелчком мыши открыть окно *Настройка данных колонки*. Далее в этом окне в качестве *Типа данных* следует указать _поле раздела_ и по кнопке поля *Элемент* открыть окно *Выбор раздела*. Теперь в этом окне можно выбрать поле, из которого будет считываться информация; для выбора доступны поля оригинального и всех присоединенных разделов.

На рисунке представлен пример выбора поля для настройки элемента представления, отображающегося в колонке *Вид*. В качестве раздела указывается присоединенный раздел _DocumentTypes_1_ (название псевдонима по умолчанию; псевдоним виден в списке доступных разделов). Далее в этом разделе выбирается нужное поле (в данном случае -- `Название` вида документа).

image::Select_Item_Name.png[Окно "Выбор раздела"]

Флажки окна *Присоединенный раздел* позволяют выводить в представлении данные иерархии:

* *Раскрывать иерархию присоединяемого раздела* -- основной флаг, при установке которого становятся доступными остальные флаги секции;
* при установленном флаге *Присоединять родительские элементы иерархии* иерархия будет раскрыта в сторону родительских элементов, при снятом -- в сторону дочерних;
* установка флага *Выводить только корневой родительский элемент* позволяет вывести в представление только корневой элемент иерархии, минуя все промежуточные (например, для элемента _Сотрудник_ в представлении будет выведен элемент _Организация_ без элемента _Подразделение_);
* счетчик, активизирующийся при установленном флаге *Ограничивать вывод иерархии уровнем <...>*, позволяет указать уровень выводимых в представление узлов иерархии относительно текущего элемента.

В поле *Условие на основной раздел представления* окна *Настройка элементов представления* определяются условия вывода данных ведущего (основного) раздела карточки в представлении. Задаются эти условия так же, как и описанные далее условия присоединения раздела.

